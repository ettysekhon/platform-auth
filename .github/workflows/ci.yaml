name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  HELM_VERSION: "4.0.4"
  GKE_CLUSTER: dev
  GKE_ZONE: europe-west2-a
  NAMESPACE: auth-platform
  HELM_RELEASE: platform-auth

jobs:
  secrets:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: secrets
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm Lint
        run: helm lint ./helm

      - name: Helm Template
        run: helm template ${{ env.HELM_RELEASE }} ./helm -f helm/values.yaml --debug > /dev/null

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: helm/
          config_file: .yamllint.yaml

      - name: Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: "**/*.md"
          config: .markdownlint.json

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: secrets
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: ./helm
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-results.sarif
          exit-code: "1"
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Install Pluto
        uses: FairwindsOps/pluto/github-action@v5.21.0

      - name: Check Deprecated APIs
        run: pluto detect-files -d ./helm

  chart-test:
    name: Chart Testing
    runs-on: ubuntu-latest
    needs: [lint, security]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Setup chart-testing
        uses: helm/chart-testing-action@v2

      - name: Create Kind cluster
        uses: helm/kind-action@v1

      - name: Create namespace and secrets
        run: |
          kubectl create namespace ${{ env.NAMESPACE }}
          kubectl create secret generic ${{ env.HELM_RELEASE }}-postgres \
            --namespace ${{ env.NAMESPACE }} \
            --from-literal=username=test \
            --from-literal=password=test
          kubectl create secret generic ${{ env.HELM_RELEASE }}-keycloak-admin \
            --namespace ${{ env.NAMESPACE }} \
            --from-literal=password=test

      - name: Helm dry-run
        run: |
          helm install ${{ env.HELM_RELEASE }} ./helm \
            --namespace ${{ env.NAMESPACE }} \
            --dry-run --debug

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: chart-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    environment: dev

    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Deploy
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./helm \
            --namespace ${{ env.NAMESPACE }} \
            --values helm/values.yaml \
            --wait --atomic --timeout 10m

      - name: Verify
        run: |
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-keycloak \
            --namespace ${{ env.NAMESPACE }} --timeout=5m
